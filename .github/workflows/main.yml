name: Staged Update (US -> EU -> Asia)

on:
  schedule:
    # UTC 0点=北京8点，UTC 12点=北京20点(晚高峰)
    - cron: '0 0,12 * * *'
  workflow_dispatch:      # 允许手动触发
  push:
    paths:
      - 'manual_ips.txt'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download CloudflareST
        run: |
          wget -N https://github.com/XIU2/CloudflareSpeedTest/releases/download/v2.2.5/CloudflareST_linux_amd64.tar.gz
          tar -zxf CloudflareST_linux_amd64.tar.gz
          chmod +x CloudflareST
          # 初始化 git 配置，方便后面多次提交
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # =======================================================
      # 第一阶段：加载手动IP + 极速扫描美国 (西岸LAX + 东岸JFK)
      # =======================================================
      - name: Stage 1 - Manual & US Nodes
        env:
          MY_UUID: ${{ secrets.UUID }}
          MY_HOST: ${{ secrets.HOST }}
        run: |
          echo "--- Stage 1: Initializing & US Scan ---"
          > final_subs.txt

          # 1.1 先写入手动优选 IP (优先级最高)
          if [ -f "manual_ips.txt" ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ -z "$line" ]] || [[ "$line" =~ ^# ]]; then continue; fi
              IP=$(echo "$line" | cut -d'#' -f1 | xargs)
              CC=$(echo "$line" | cut -d'#' -f2 | xargs)
              if [[ -n "$IP" ]]; then
                if [[ -z "$CC" ]]; then CC="LocalBest"; fi
                REMARK="★Manual_${CC}_${IP}"
                LINK="vless://${MY_UUID}@${IP}:443?encryption=none&security=tls&sni=${MY_HOST}&fp=chrome&type=ws&host=${MY_HOST}&path=%2F%3Fed%3D2048#${REMARK}"
                echo "$LINK" >> final_subs.txt
              fi
            done < manual_ips.txt
          fi

          # 1.2 扫描美国西岸 (LAX) - 只要1个最快的
          ./CloudflareST -cfcolo LAX -tp 443 -n 20 -dn 1 -dd -tll 0 -tl 500 -p 0 -o result_lax.csv
          IP=$(sed -n '2p' result_lax.csv | cut -d',' -f1)
          if [ -n "$IP" ]; then
             echo "vless://${MY_UUID}@${IP}:443?encryption=none&security=tls&sni=${MY_HOST}&fp=chrome&type=ws&host=${MY_HOST}&path=%2F%3Fed%3D2048#Auto_US_West_${IP}" >> final_subs.txt
          fi

          # 1.3 扫描美国东岸 (JFK) - 只要1个最快的
          ./CloudflareST -cfcolo JFK -tp 443 -n 20 -dn 1 -dd -tll 0 -tl 500 -p 0 -o result_jfk.csv
          IP=$(sed -n '2p' result_jfk.csv | cut -d',' -f1)
          if [ -n "$IP" ]; then
             echo "vless://${MY_UUID}@${IP}:443?encryption=none&security=tls&sni=${MY_HOST}&fp=chrome&type=ws&host=${MY_HOST}&path=%2F%3Fed%3D2048#Auto_US_East_${IP}" >> final_subs.txt
          fi

          # 1.4 生成订阅并推送 (第一次推送)
          base64 final_subs.txt > sub_base64.txt
          git add final_subs.txt sub_base64.txt
          git pull --rebase origin main || git pull origin main
          git commit -m "Update Stage 1 (US Nodes): $(date)" || echo "No changes to commit"
          git push origin main

      # =======================================================
      # 第二阶段：追加欧洲节点 (德国FRA + 英国LHR + 法国CDG)
      # =======================================================
      - name: Stage 2 - EU Nodes
        env:
          MY_UUID: ${{ secrets.UUID }}
          MY_HOST: ${{ secrets.HOST }}
        run: |
          echo "--- Stage 2: EU Scan ---"
          
          # 定义欧洲机场代码
          EU_COLO=("DE:FRA" "GB:LHR" "FR:CDG")

          for LOC in "${EU_COLO[@]}"; do
            COUNTRY=${LOC%%:*}
            COLO=${LOC##*:}
            # 扫描
            ./CloudflareST -cfcolo $COLO -tp 443 -n 20 -dn 1 -dd -tll 0 -tl 500 -p 0 -o "result_eu.csv"
            IP=$(sed -n '2p' "result_eu.csv" | cut -d',' -f1)
            if [ -n "$IP" ]; then
               echo "vless://${MY_UUID}@${IP}:443?encryption=none&security=tls&sni=${MY_HOST}&fp=chrome&type=ws&host=${MY_HOST}&path=%2F%3Fed%3D2048#Auto_${COUNTRY}_${IP}" >> final_subs.txt
            fi
          done

          # 2.2 更新订阅并推送 (第二次推送)
          base64 final_subs.txt > sub_base64.txt
          git add final_subs.txt sub_base64.txt
          git pull --rebase origin main || git pull origin main
          git commit -m "Update Stage 2 (EU Nodes): $(date)" || echo "No changes to commit"
          git push origin main

      # =======================================================
      # 第三阶段：追加亚洲节点 (香港HKG + 日本NRT + 新加坡SIN)
      # =======================================================
      - name: Stage 3 - Asia Nodes
        env:
          MY_UUID: ${{ secrets.UUID }}
          MY_HOST: ${{ secrets.HOST }}
        run: |
          echo "--- Stage 3: Asia Scan ---"
          
          ASIA_COLO=("HK:HKG" "JP:NRT" "SG:SIN")

          for LOC in "${ASIA_COLO[@]}"; do
            COUNTRY=${LOC%%:*}
            COLO=${LOC##*:}
            # 亚洲节点可能比较难找，稍微放宽一点延迟限制，或者多扫一点点
            ./CloudflareST -cfcolo $COLO -tp 443 -n 20 -dn 1 -dd -tll 0 -tl 800 -p 0 -o "result_asia.csv"
            IP=$(sed -n '2p' "result_asia.csv" | cut -d',' -f1)
            if [ -n "$IP" ]; then
               echo "vless://${MY_UUID}@${IP}:443?encryption=none&security=tls&sni=${MY_HOST}&fp=chrome&type=ws&host=${MY_HOST}&path=%2F%3Fed%3D2048#Auto_${COUNTRY}_${IP}" >> final_subs.txt
            fi
          done

          # 3.2 更新订阅并推送 (最后一次推送)
          base64 final_subs.txt > sub_base64.txt
          git add final_subs.txt sub_base64.txt
          git pull --rebase origin main || git pull origin main
          git commit -m "Update Stage 3 (Asia Nodes): $(date)" || echo "No changes to commit"
          git push origin main
